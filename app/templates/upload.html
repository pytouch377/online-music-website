{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h2 class="card-title mb-0">{{ _('Upload New Song') }}</h2>
            </div>
            <div class="card-body">
                <form action="" method="post" enctype="multipart/form-data" novalidate>
                    {{ form.hidden_tag() }}
                    
                    <!-- æ–‡ä»¶ä¸Šä¼ éƒ¨åˆ† - æ”¾åœ¨ä¸Šé¢ -->
                    <div class="mb-4">
                        <h5 class="text-primary mb-3">ğŸ“ {{ _('Upload Files') }}</h5>
                        
                        <div class="mb-3">
                            <label for="audio_file" class="form-label fw-bold required">
                                {{ 'éŸ³é¢‘æ–‡ä»¶' if current_locale and current_locale.language == 'zh' else 'Audio File' }}
                            </label>
                            <div class="input-group">
                                {{ form.audio_file(class="form-control", id="audio_file") }}
                            </div>
                            {% for error in form.audio_file.errors %}
                            <div class="text-danger">{{ error }}</div>
                            {% endfor %}
                            <div class="form-text">
                                <span id="audio-file-name" class="text-muted" data-default-text="{{ _('No file chosen') }}">{{ _('No file chosen') }}</span> â€¢ 
                                {{ _('Supported formats: MP3, WAV, OGG, FLAC, M4A (max 16MB)') }}
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="cover_image" class="form-label fw-bold">
                                {{ 'å°é¢å›¾ç‰‡ï¼ˆå¯é€‰ï¼‰' if current_locale and current_locale.language == 'zh' else 'Cover Image (optional)' }}
                            </label>
                            <div class="input-group">
                                {{ form.cover_image(class="form-control", id="cover_image") }}
                            </div>
                            {% for error in form.cover_image.errors %}
                            <div class="text-danger">{{ error }}</div>
                            {% endfor %}
                            <div class="form-text">
                                <span id="cover-file-name" class="text-muted" data-default-text="{{ _('No file chosen') }}">{{ _('No file chosen') }}</span> â€¢ 
                                {{ _('Optional: JPG, PNG, GIF (album cover art)') }}
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                {{ form.auto_search_cover(class="form-check-input", id="auto_search_cover") }}
                                <label class="form-check-label" for="auto_search_cover">
                                    {{ 'è‡ªåŠ¨åœ¨çº¿æœç´¢å°é¢' if current_locale and current_locale.language == 'zh' else 'Auto search cover online' }}
                                </label>
                            </div>
                            <div class="form-text">
                                {{ _('If no cover image is uploaded, automatically search and download cover art online') }}
                            </div>
                        </div>
                    </div>
                    
                    <!-- æ­Œæ›²ä¿¡æ¯éƒ¨åˆ† - æ”¾åœ¨ä¸­é—´ -->
                    <div class="mb-4">
                        <h5 class="text-primary mb-3">ğŸµ {{ _('Song Information') }}</h5>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="title" class="form-label fw-bold required">
                                        {{ 'æ­Œæ›²æ ‡é¢˜' if current_locale and current_locale.language == 'zh' else 'Song Title' }}
                                    </label>
                                    {{ form.title(class="form-control", placeholder=_('Enter song title'), id="title") }}
                                    {% for error in form.title.errors %}
                                    <div class="text-danger">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="artist" class="form-label fw-bold required">
                                        {{ form.artist.label.text }}
                                    </label>
                                    {{ form.artist(class="form-control", placeholder=_('Enter artist name'), id="artist") }}
                                    {% for error in form.artist.errors %}
                                    <div class="text-danger">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="album" class="form-label">
                                        {{ form.album.label.text }}
                                    </label>
                                    {{ form.album(class="form-control", placeholder=_('Enter album name (optional)')) }}
                                    {% for error in form.album.errors %}
                                    <div class="text-danger">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="genre" class="form-label">
                                        {{ form.genre.label.text }}
                                    </label>
                                    {{ form.genre(class="form-control", placeholder=_('Enter genre (optional)')) }}
                                    {% for error in form.genre.errors %}
                                    <div class="text-danger">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- å¯è§æ€§è®¾ç½® - æ”¾åœ¨ä¸‹é¢ -->
                    <div class="mb-4">
                        <h5 class="text-primary mb-3">ğŸ‘ï¸ {{ _('Visibility Settings') }}</h5>
                        
                        <div class="mb-3">
                            <label for="visibility" class="form-label fw-bold">
                                {{ 'å¯è§æ€§' if current_locale and current_locale.language == 'zh' else 'Visibility' }}
                            </label>
                            <select class="form-select" id="visibility" name="{{ form.visibility.name }}">
                                <option value="public" {% if form.visibility.data == 'public' %}selected{% endif %}>
                                    {{ 'å…¬å¼€ - ä¸æ‰€æœ‰äººåˆ†äº«' if current_locale and current_locale.language == 'zh' else 'Public - Share with everyone' }}
                                </option>
                                <option value="private" {% if form.visibility.data == 'private' %}selected{% endif %}>
                                    {{ 'ç§äºº - ä»…è‡ªå·±å¯è§' if current_locale and current_locale.language == 'zh' else 'Private - Only visible to me' }}
                                </option>
                            </select>
                            {% for error in form.visibility.errors %}
                            <div class="text-danger">{{ error }}</div>
                            {% endfor %}
                            <div class="form-text">
                                {{ _('Choose who can see this song. Public songs are visible to all users, private songs are only visible to you.') }}
                            </div>
                        </div>
                    </div>
                    
                    <!-- å¿…å¡«å­—æ®µè¯´æ˜ -->
                    <div class="alert alert-light border mb-4">
                        <small class="text-muted">
                            <span class="text-danger">*</span> {{ _('Indicates required fields') }}
                        </small>
                    </div>
                    
                    <!-- æäº¤æŒ‰é’® -->
                    <div class="mb-3">
                        {{ form.submit(
                            class="btn btn-primary btn-lg w-100",
                            id="submit-btn",
                            value=('ä¸Šä¼ æ­Œæ›²' if current_locale and current_locale.language == 'zh' else 'Upload Song')
                        ) }}
                        <a href="{{ url_for('main.library') }}" class="btn btn-secondary w-100 mt-2">{{ _('Cancel') }}</a>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Upload Guidelines -->
        <div class="card mt-4">
            <div class="card-body">
                <h5 class="text-primary">ğŸ“‹ {{ _('Upload Guidelines') }}</h5>
                <div class="row">
                    <div class="col-md-6">
                        <ul class="mb-0">
                            <li>{{ _('Ensure you have the rights to upload the music') }}</li>
                            <li>{{ _('Audio files should be good quality (128kbps or higher)') }}</li>
                            <li>{{ _('File size limit: 16MB per file') }}</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <ul class="mb-0">
                            <li>{{ _('Cover images should be at least 300x300 pixels') }}</li>
                            <li>{{ _('Public songs will be visible to all users') }}</li>
                            <li>{{ _('Private songs are only visible to you') }}</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.form-label.fw-bold {
    color: #495057;
}
.text-primary {
    color: #1db954 !important;
}
.card {
    border: none;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}
.card-header {
    background-color: #1db954;
    color: white;
    border-bottom: none;
}
.btn-primary {
    background-color: #1db954;
    border-color: #1db954;
}
.btn-primary:hover {
    background-color: #1ed760;
    border-color: #1ed760;
}
/* ç¦ç”¨æŒ‰é’®æ ·å¼ */
.btn:disabled {
    background-color: #6c757d;
    border-color: #6c757d;
    cursor: not-allowed;
}
/* æ–‡ä»¶é€‰æ‹©åé¦ˆ */
.file-name {
    font-weight: 500;
}
.file-name.has-file {
    color: #198754;
}
/* å¿…å¡«å­—æ®µæ˜Ÿå·æ ·å¼ */
.required::after {
    content: " *";
    color: #dc3545;
    font-weight: bold;
}
/* å¿…å¡«å­—æ®µè¯´æ˜ */
.alert-light {
    background-color: #f8f9fa;
    border-color: #dee2e6;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    const audioFileInput = document.getElementById('audio_file');
    const titleInput = document.getElementById('title');
    const artistInput = document.getElementById('artist');
    const submitBtn = document.getElementById('submit-btn');
    const audioFileName = document.getElementById('audio-file-name');
    const coverFileName = document.getElementById('cover-file-name');
    const coverImageInput = document.getElementById('cover_image');
    const autoSearchCover = document.getElementById('auto_search_cover');
    const uploadMessages = {{ {
        "no_file_chosen": _('No file chosen'),
        "fill_required": _('Please fill in all required fields (marked with *): audio file, song title, and artist name.'),
        "confirm_use_auto": _('You have already uploaded a cover image. Do you want to clear the file and use automatic search?')
    }|tojson }};
    
    // å®æ—¶éªŒè¯å‡½æ•°
    function validateForm() {
        const audioFile = audioFileInput.files[0];
        const title = titleInput.value.trim();
        const artist = artistInput.value.trim();
        
        // æ£€æŸ¥å¿…å¡«å­—æ®µ
        const isValid = audioFile && title && artist;
        
        // æ›´æ–°æäº¤æŒ‰é’®çŠ¶æ€
        if (isValid) {
            submitBtn.disabled = false;
            submitBtn.classList.remove('btn-secondary');
            submitBtn.classList.add('btn-primary');
        } else {
            submitBtn.disabled = true;
            submitBtn.classList.remove('btn-primary');
            submitBtn.classList.add('btn-secondary');
        }
        
        return isValid;
    }
    
    // æ›´æ–°æ–‡ä»¶åæ˜¾ç¤º
    function updateFileNameDisplay(inputElement, displayElement) {
        if (inputElement.files[0]) {
            displayElement.textContent = inputElement.files[0].name;
            displayElement.classList.add('file-name', 'has-file');
        } else {
            displayElement.textContent = displayElement.dataset.defaultText || uploadMessages.no_file_chosen;
            displayElement.classList.remove('file-name', 'has-file');
        }
    }
    
    // æ·»åŠ è¾“å…¥ç›‘å¬äº‹ä»¶
    audioFileInput.addEventListener('change', function() {
        updateFileNameDisplay(audioFileInput, audioFileName);
        validateForm();
    });
    
    coverImageInput.addEventListener('change', function() {
        updateFileNameDisplay(this, coverFileName);
        // å¦‚æœç”¨æˆ·ä¸Šä¼ äº†å°é¢ï¼Œè‡ªåŠ¨å–æ¶ˆè‡ªåŠ¨æœç´¢
        if (this.files[0]) {
            autoSearchCover.checked = false;
        }
    });
    
    // è‡ªåŠ¨æœç´¢å°é¢å¤é€‰æ¡†äº‹ä»¶
    autoSearchCover.addEventListener('change', function() {
        if (this.checked && coverImageInput.files[0]) {
            // å¦‚æœå‹¾é€‰äº†è‡ªåŠ¨æœç´¢ä½†å·²ç»æœ‰ä¸Šä¼ æ–‡ä»¶ï¼Œæç¤ºç”¨æˆ·
            if (confirm(uploadMessages.confirm_use_auto)) {
                coverImageInput.value = '';
                updateFileNameDisplay(coverImageInput, coverFileName);
            } else {
                this.checked = false;
            }
        }
    });
    
    titleInput.addEventListener('input', validateForm);
    artistInput.addEventListener('input', validateForm);
    
    // åˆå§‹éªŒè¯å’Œæ–‡ä»¶åæ˜¾ç¤º
    updateFileNameDisplay(audioFileInput, audioFileName);
    updateFileNameDisplay(coverImageInput, coverFileName);
    validateForm();
    
    // è¡¨å•æäº¤å‰çš„æœ€ç»ˆéªŒè¯
    form.addEventListener('submit', function(e) {
        if (!validateForm()) {
            e.preventDefault();
            alert(uploadMessages.fill_required);
        }
    });
});
</script>
{% endblock %}
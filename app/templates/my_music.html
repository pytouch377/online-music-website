{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>{{ _('My Music') }}</h2>
            <a href="{{ url_for('main.upload') }}" class="btn btn-primary">{{ _('Upload New Song') }}</a>
        </div>
        
        {% if songs.items %}
        <div class="row">
            {% for song in songs.items %}
            <div class="col-md-4 mb-4">
                <div class="card h-100">
                    {% if song.cover_image %}
                    <img src="{{ url_for('static', filename=song.cover_image) }}" class="card-img-top" alt="{{ song.title }}" style="height: 200px; object-fit: contain; background-color: #f8f9fa;">
                    {% else %}
                    <div class="card-img-top bg-secondary d-flex align-items-center justify-content-center" style="height: 200px;">
                        <span class="text-white">{{ _('No Cover') }}</span>
                    </div>
                    {% endif %}
                    <div class="card-body">
                        <h5 class="card-title">
                            <a href="{{ url_for('main.song_detail', song_id=song.id) }}" class="text-decoration-none">
                                {{ song.title }}
                            </a>
                        </h5>
                        <p class="card-text mb-1">
                            <strong>{{ _('Artist') }}:</strong> {{ song.artist }}<br>
                            {% if song.album %}<strong>{{ _('Album') }}:</strong> {{ song.album }}<br>{% endif %}
                        </p>
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>{{ _('Visibility') }}:</strong> 
                                <span class="badge {% if song.visibility == 'public' %}bg-success{% else %}bg-secondary{% endif %}">
                                    {% if song.visibility == 'public' %}
                                        {{ _('Public') }}
                                    {% else %}
                                        {{ _('Private') }}
                                    {% endif %}
                                </span>
                            </div>
                            <form action="{{ url_for('main.update_song_visibility', song_id=song.id) }}" method="post" class="visibility-form">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <input type="hidden" name="visibility" value="{{ 'private' if song.visibility == 'public' else 'public' }}">
                                <div class="form-check form-switch mb-0">
                                    <input class="form-check-input visibility-toggle" type="checkbox"
                                           role="switch" {% if song.visibility == 'public' %}checked{% endif %}>
                                </div>
                            </form>
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <button class="btn btn-primary btn-sm play-btn" data-song-id="{{ song.id }}">
                                    {{ _('Play') }}
                                </button>
                                {% if current_user.is_authenticated %}
                                <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" 
                                        data-bs-target="#addToPlaylistModal" data-song-id="{{ song.id }}">
                                    {{ _('Add to Playlist') }}
                                </button>
                                {% endif %}
                            </div>
                            <div>
                                <!-- Êõ¥Êç¢Â∞ÅÈù¢ÊåâÈíÆ -->
                                <button class="btn btn-outline-info btn-sm update-cover-btn" 
                                        data-song-id="{{ song.id }}" title="{{ _('Search new cover (click multiple times for different options)') }}">
                                    üé®
                                </button>
                                <!-- Âà†Èô§ÊåâÈíÆ -->
                                <form action="{{ url_for('main.delete_song', song_id=song.id) }}" method="post" 
                                      class="delete-form d-inline" data-confirm="{{ _('Are you sure you want to delete this song?') }}">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <button type="submit" class="btn btn-outline-danger btn-sm">
                                        üóëÔ∏è
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- ÂàÜÈ°µ -->
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center">
                {% if songs.has_prev %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('main.my_music', page=songs.prev_num) }}">{{ _('Previous') }}</a>
                </li>
                {% endif %}
                
                {% for page_num in songs.iter_pages(left_edge=2, right_edge=2, left_current=2, right_current=2) %}
                    {% if page_num %}
                        <li class="page-item {% if page_num == songs.page %}active{% endif %}">
                            <a class="page-link" href="{{ url_for('main.my_music', page=page_num) }}">{{ page_num }}</a>
                        </li>
                    {% else %}
                        <li class="page-item disabled"><span class="page-link">‚Ä¶</span></li>
                    {% endif %}
                {% endfor %}
                
                {% if songs.has_next %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('main.my_music', page=songs.next_num) }}">{{ _('Next') }}</a>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% else %}
        <div class="alert alert-info">
            <h4>{{ _("You haven't uploaded any music yet") }}</h4>
            <p>{{ _('Start building your music collection by uploading your first song!') }}</p>
            <a href="{{ url_for('main.upload') }}" class="btn btn-primary">{{ _('Upload Your First Song') }}</a>
        </div>
        {% endif %}
    </div>
</div>

<!-- Add to Playlist Modal -->
<div class="modal fade" id="addToPlaylistModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ _('Add to Playlist') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addToPlaylistForm">
                    <input type="hidden" id="modalSongId" name="song_id">
                    <div class="mb-3">
                        <label for="playlistSelect" class="form-label">{{ _('Select Playlist') }}</label>
                        <select class="form-select" id="playlistSelect" name="playlist_id" required>
                            <option value="">{{ _('Choose a playlist...') }}</option>
                            {% for playlist in current_user.playlists %}
                            <option value="{{ playlist.id }}">{{ playlist.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">{{ _('Add to Playlist') }}</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script id="coverMessagesData" type="application/json">
    {{ {
        "success": _('Cover updated successfully!'),
        "failure": _('Failed to update cover: %(error)s', error='%(error)s'),
        "failure_unknown": _('Failed to update cover. Please try again later.'),
        "unknown_error": _('Unknown error')
    }|tojson }}
</script>

<script>
// @ts-nocheck
document.addEventListener('DOMContentLoaded', function() {
    const coverMessages = JSON.parse(document.getElementById('coverMessagesData').textContent);
    const csrfMeta = document.querySelector('meta[name="csrf-token"]');
    const csrfToken = csrfMeta ? csrfMeta.getAttribute('content') : '';

    // ÂèØËßÅÊÄßÊªëÂùóÔºöÂàáÊç¢ÂÖ¨ÂºÄ/ÁßÅ‰∫∫
    document.querySelectorAll('.visibility-form').forEach(form => {
        const toggle = form.querySelector('.visibility-toggle');
        const hiddenInput = form.querySelector('input[name="visibility"]');
        const badge = form.closest('.d-flex').querySelector('.badge');
        if (!toggle || !hiddenInput) return;

        toggle.addEventListener('change', function() {
            const newVisibility = this.checked ? 'public' : 'private';
            hiddenInput.value = newVisibility;

            const formData = new FormData(form);

            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                if (badge) {
                    badge.classList.remove('bg-success', 'bg-secondary');
                    if (newVisibility === 'public') {
                        badge.classList.add('bg-success');
                        badge.textContent = "{{ _('Public') }}";
                    } else {
                        badge.classList.add('bg-secondary');
                        badge.textContent = "{{ _('Private') }}";
                    }
                }
            })
            .catch(error => {
                console.error('Error updating visibility:', error);
                // Â§±Ë¥•Êó∂ÊÅ¢Â§çÂºÄÂÖ≥Áä∂ÊÄÅ
                this.checked = !this.checked;
                hiddenInput.value = this.checked ? 'public' : 'private';
            });
        });
    });

    // Êõ¥Êç¢Â∞ÅÈù¢ÊåâÈíÆ‰∫ã‰ª∂
    document.querySelectorAll('.update-cover-btn').forEach(button => {
        button.addEventListener('click', function() {
            const songId = this.dataset.songId;
            const originalText = this.innerHTML;
            
            // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            this.innerHTML = '‚è≥';
            this.disabled = true;
            
            fetch(`/api/update_cover/${songId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('Cover update response:', data); // Ë∞ÉËØï‰ø°ÊÅØ
                    
                    // Êõ¥Êñ∞Â∞ÅÈù¢ÂõæÁâá
                    const card = this.closest('.card');
                    const img = card.querySelector('.card-img-top');
                    const timestamp = Date.now();
                    const newUrl = data.new_cover_url + '?v=' + timestamp;
                    
                    if (img.tagName === 'IMG') {
                        // Âº∫Âà∂Âà∑Êñ∞ÂõæÁâá
                        img.onload = function() {
                            console.log('New cover loaded successfully');
                        };
                        img.src = newUrl;
                    } else {
                        // Â¶ÇÊûúÂéüÊù•Ê≤°ÊúâÂ∞ÅÈù¢ÔºåÊõøÊç¢‰∏∫ÂõæÁâá
                        const newImg = document.createElement('img');
                        newImg.src = newUrl;
                        newImg.className = 'card-img-top';
                        newImg.alt = card.querySelector('.card-title').textContent;
                        newImg.style.cssText = 'height: 200px; object-fit: contain; background-color: #f8f9fa;';
                        newImg.onload = function() {
                            console.log('New cover created and loaded');
                        };
                        img.replaceWith(newImg);
                    }
                } else {
                    const errorText = data.error ? coverMessages.failure.replace('%(error)s', data.error) : coverMessages.failure.replace('%(error)s', coverMessages.unknown_error);
                    alert(errorText);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert(coverMessages.failure_unknown);
            })
            .finally(() => {
                // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
                this.innerHTML = originalText;
                this.disabled = false;
            });
        });
    });
});
</script>
{% endblock %}